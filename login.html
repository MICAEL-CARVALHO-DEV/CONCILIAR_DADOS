<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Prototipo SEC Emendas</title>
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="login-page">
  <main class="login-layout">
    <section class="login-brand login-animate-left">
      <div class="login-logo-frame">
        <div class="login-logo-flip">
          <img
            src="assets/sec-logo.png"
            alt="Brasao do Estado da Bahia"
            class="login-logo"
            onerror="var frame=this.closest('.login-logo-frame'); if(frame){ frame.style.display='none'; } else { this.style.display='none'; }"
          />
        </div>
      </div>
      <div class="login-title-shell">
        <h1 class="login-title" aria-label="Sistema Gestao Emendas">
          <span class="login-title-line" data-text="SISTEMA" style="--line-index: 0;"><span class="login-title-line-core">SISTEMA</span></span>
          <span class="login-title-line" data-text="GESTAO" style="--line-index: 1;"><span class="login-title-line-core">GESTAO</span></span>
          <span class="login-title-line" data-text="EMENDAS" style="--line-index: 2;"><span class="login-title-line-core">EMENDAS</span></span>
        </h1>
      </div>
    </section>

    <section class="login-panel-wrap login-animate-card">
      <div class="login-panel-glass">
        <div class="login-panel">
          <h2 class="login-panel-title" data-text="Login">Login</h2>
          <form id="loginForm" class="auth-form">
            <div class="field login-field">
              <div class="login-input-wrap">
                <span class="login-input-icon" aria-hidden="true">👤</span>
                <input id="nome" autocomplete="username" placeholder="Nome" aria-label="Nome" required />
              </div>
            </div>
            <div class="field login-field">
              <div class="login-input-wrap">
                <span class="login-input-icon" aria-hidden="true">🔒</span>
                <input id="senha" type="password" autocomplete="current-password" placeholder="Senha" aria-label="Senha" required />
              </div>
            </div>
            <button type="submit" class="btn primary login-submit">Acessar</button>
          </form>

          <div class="login-links">
            <a class="btn login-link" id="linkCadastro" href="cadastro.html">Cadastrar</a>
          </div>

          <p class="login-help-text muted small">Esqueceu a senha ?</p>
          <p id="msg" class="login-msg muted small"></p>
        </div>
      </div>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="config.production.js"></script>
  <script>
    (function () {
      const API_BASE_URL_KEY = "SEC_API_BASE_URL";
      const CFG = (window.SEC_APP_CONFIG && typeof window.SEC_APP_CONFIG === "object") ? window.SEC_APP_CONFIG : {};
      const CFG_HOST_MAP = (CFG.API_BASE_URL_BY_HOST && typeof CFG.API_BASE_URL_BY_HOST === "object") ? CFG.API_BASE_URL_BY_HOST : {};
      const CFG_HOST = (window.location && window.location.hostname) ? String(window.location.hostname) : "";
      const DEFAULT_API_BASE_URL = (CFG_HOST_MAP[CFG_HOST] ? String(CFG_HOST_MAP[CFG_HOST]) : "") || (CFG.API_BASE_URL ? String(CFG.API_BASE_URL) : "") || "http://localhost:8000";
      const SESSION_TOKEN_KEY = "SEC_SESSION_TOKEN";
      const USER_NAME_KEY = "SEC_USER_NAME";
      const USER_ROLE_KEY = "SEC_USER_ROLE";
      const next = new URLSearchParams(window.location.search).get("next") || "index.html";
      const incomingMsg = new URLSearchParams(window.location.search).get("msg") || "";

      const form = document.getElementById("loginForm");
      const nome = document.getElementById("nome");
      const senha = document.getElementById("senha");
      const msg = document.getElementById("msg");
      if (sessionStorage.getItem(SESSION_TOKEN_KEY)) {
        window.location.href = next;
        return;
      }

      const linkCadastro = document.getElementById("linkCadastro");

      linkCadastro.href = "cadastro.html?next=" + encodeURIComponent(next);
      if (incomingMsg && incomingMsg !== "Entre para continuar.") msg.textContent = incomingMsg;

      function getBaseUrl() {
        const raw = String(localStorage.getItem(API_BASE_URL_KEY) || "").trim();
        const base = raw || DEFAULT_API_BASE_URL;
        return base.replace(/\/+$/, "");
      }

      async function apiRequest(path, body) {
        const resp = await fetch(getBaseUrl() + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const text = await resp.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch (_) {}

        if (!resp.ok) {
          const detail = json && json.detail ? json.detail : (text || ("HTTP " + resp.status));
          throw new Error(String(detail));
        }
        return json;
      }

      function persistSession(data, fallbackName, fallbackRole) {
        sessionStorage.setItem(SESSION_TOKEN_KEY, String(data.token || ""));
        localStorage.setItem(USER_NAME_KEY, String(data.usuario && data.usuario.nome || fallbackName || ""));
        localStorage.setItem(USER_ROLE_KEY, String(data.usuario && data.usuario.perfil || fallbackRole || "CONTABIL"));
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const n = String(nome.value || "").trim();
        const s = String(senha.value || "").trim();
        if (!n || !s) {
          msg.textContent = "Informe nome e senha.";
          msg.style.color = "#b4233d";
          return;
        }

        msg.textContent = "Autenticando...";
        msg.style.color = "";

        try {
          const data = await apiRequest("/auth/login", { nome: n, senha: s });
          persistSession(data, n, "CONTABIL");
          window.location.href = next;
        } catch (err) {
          msg.textContent = err && err.message ? err.message : "Falha no login.";
          msg.style.color = "#b4233d";
        }
      });

    })();
  </script>
</body>
</html>
