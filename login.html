<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Prototipo SEC Emendas</title>
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="login-page">
  <main class="login-layout">
    <section class="login-brand login-animate-left">
      <div class="login-logo-frame">
        <div class="login-logo-flip">
          <img
            src="assets/sec-logo.png"
            alt="Brasao do Estado da Bahia"
            class="login-logo"
            onerror="var frame=this.closest('.login-logo-frame'); if(frame){ frame.style.display='none'; } else { this.style.display='none'; }"
          />
        </div>
      </div>
      <div class="login-title-shell">
        <h1 class="login-title" aria-label="Sistema Gestao Emendas">
          <span class="login-title-line" data-text="SISTEMA" style="--line-index: 0;"><span class="login-title-line-core">SISTEMA</span></span>
          <span class="login-title-line" data-text="GESTAO" style="--line-index: 1;"><span class="login-title-line-core">GESTAO</span></span>
          <span class="login-title-line" data-text="EMENDAS" style="--line-index: 2;"><span class="login-title-line-core">EMENDAS</span></span>
        </h1>
      </div>
    </section>

    <section class="login-panel-wrap login-animate-card">
      <div class="login-panel-glass">
        <div class="login-panel">
          <h2 class="login-panel-title" data-text="Login">Login</h2>
          <form id="loginForm" class="auth-form">
            <div class="field login-field">
              <div class="login-input-wrap">
                <span class="login-input-icon" aria-hidden="true">👤</span>
                <input id="nome" autocomplete="username" placeholder="Nome de usuario ou Gmail" aria-label="Nome de usuario ou Gmail" required />
              </div>
            </div>
            <div class="field login-field">
              <div class="login-input-wrap">
                <span class="login-input-icon" aria-hidden="true">🔒</span>
                <input id="senha" type="password" autocomplete="current-password" placeholder="Senha" aria-label="Senha" required />
              </div>
            </div>
            <button type="submit" class="btn primary login-submit">Acessar</button>
          </form>

          <div id="googleAuthBlock" class="google-auth-block" hidden>
            <div class="login-divider"><span>ou</span></div>
            <div id="googleLoginButton" class="google-login-slot"></div>
          </div>

          <div class="login-links">
            <a class="btn login-link" id="linkCadastro" href="cadastro.html">Cadastrar</a>
          </div>

          <p class="login-help-text muted small">Esqueceu a senha ?</p>
          <p id="msg" class="login-msg muted small"></p>
        </div>
      </div>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="config.production.js"></script>
  <script>
    (async function () {
      const API_BASE_URL_KEY = "SEC_API_BASE_URL";
      const CFG = (window.SEC_APP_CONFIG && typeof window.SEC_APP_CONFIG === "object") ? window.SEC_APP_CONFIG : {};
      const CFG_HOST_MAP = (CFG.API_BASE_URL_BY_HOST && typeof CFG.API_BASE_URL_BY_HOST === "object") ? CFG.API_BASE_URL_BY_HOST : {};
      const CFG_HOST = (window.location && window.location.hostname) ? String(window.location.hostname) : "";
      const IS_LOCAL_FRONTEND = !CFG_HOST || CFG_HOST === "localhost" || CFG_HOST === "127.0.0.1";
      const DEFAULT_API_BASE_URL = (CFG_HOST_MAP[CFG_HOST] ? String(CFG_HOST_MAP[CFG_HOST]) : "") || (CFG.API_BASE_URL ? String(CFG.API_BASE_URL) : "") || "http://localhost:8000";
      const CFG_GOOGLE_HOST_MAP = (CFG.GOOGLE_CLIENT_ID_BY_HOST && typeof CFG.GOOGLE_CLIENT_ID_BY_HOST === "object") ? CFG.GOOGLE_CLIENT_ID_BY_HOST : {};
      const GOOGLE_CLIENT_ID = (CFG_GOOGLE_HOST_MAP[CFG_HOST] ? String(CFG_GOOGLE_HOST_MAP[CFG_HOST]) : "") || (CFG.GOOGLE_CLIENT_ID ? String(CFG.GOOGLE_CLIENT_ID) : "");
      const SESSION_TOKEN_KEY = "SEC_SESSION_TOKEN";
      const USER_NAME_KEY = "SEC_USER_NAME";
      const USER_ROLE_KEY = "SEC_USER_ROLE";
      const next = new URLSearchParams(window.location.search).get("next") || "index.html";
      const incomingMsg = new URLSearchParams(window.location.search).get("msg") || "";

      const form = document.getElementById("loginForm");
      const nome = document.getElementById("nome");
      const senha = document.getElementById("senha");
      const msg = document.getElementById("msg");
      const googleAuthBlock = document.getElementById("googleAuthBlock");
      const googleLoginButton = document.getElementById("googleLoginButton");

      const linkCadastro = document.getElementById("linkCadastro");

      linkCadastro.href = "cadastro.html?next=" + encodeURIComponent(next);
      if (incomingMsg && incomingMsg !== "Entre para continuar.") msg.textContent = incomingMsg;

      function isLoopbackApiBase(value) {
        return /^https?:\/\/(?:localhost|127\.0\.0\.1|0\.0\.0\.0)(?::\d+)?(?:\/|$)/i.test(String(value || "").trim());
      }

      function getBaseUrl() {
        const raw = String(localStorage.getItem(API_BASE_URL_KEY) || "").trim();
        if (!IS_LOCAL_FRONTEND && raw && isLoopbackApiBase(raw)) {
          localStorage.removeItem(API_BASE_URL_KEY);
        }
        const base = (!IS_LOCAL_FRONTEND && isLoopbackApiBase(raw)) ? DEFAULT_API_BASE_URL : (raw || DEFAULT_API_BASE_URL);
        return base.replace(/\/+$/, "");
      }

      async function validateExistingSession() {
        const token = String(sessionStorage.getItem(SESSION_TOKEN_KEY) || "").trim();
        if (!token) return false;

        try {
          const resp = await fetch(getBaseUrl() + "/auth/me", {
            method: "GET",
            headers: {
              Authorization: "Bearer " + token,
              "X-Session-Token": token
            }
          });

          if (!resp.ok) {
            throw new Error("sessao invalida");
          }

          const data = await resp.json();
          if (data && data.nome) {
            localStorage.setItem(USER_NAME_KEY, String(data.nome));
          }
          if (data && data.perfil) {
            localStorage.setItem(USER_ROLE_KEY, String(data.perfil));
          }

          window.location.href = next;
          return true;
        } catch (_) {
          sessionStorage.removeItem(SESSION_TOKEN_KEY);
          localStorage.removeItem(USER_NAME_KEY);
          localStorage.removeItem(USER_ROLE_KEY);
          return false;
        }
      }

      if (await validateExistingSession()) {
        return;
      }

      async function apiRequest(path, body) {
        const resp = await fetch(getBaseUrl() + path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const text = await resp.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch (_) {}

        if (!resp.ok) {
          const detail = json && json.detail ? json.detail : (text || ("HTTP " + resp.status));
          throw new Error(String(detail));
        }
        return json;
      }

      async function loadExternalScript(src) {
        if (document.querySelector('script[data-ext-src="' + src + '"]')) {
          return;
        }

        await new Promise(function (resolve, reject) {
          const tag = document.createElement("script");
          tag.src = src;
          tag.async = true;
          tag.defer = true;
          tag.dataset.extSrc = src;
          tag.onload = resolve;
          tag.onerror = function () { reject(new Error("falha ao carregar script externo")); };
          document.head.appendChild(tag);
        });
      }

      function persistSession(data, fallbackName, fallbackRole) {
        sessionStorage.setItem(SESSION_TOKEN_KEY, String(data.token || ""));
        localStorage.setItem(USER_NAME_KEY, String(data.usuario && data.usuario.nome || fallbackName || ""));
        localStorage.setItem(USER_ROLE_KEY, String(data.usuario && data.usuario.perfil || fallbackRole || "CONTABIL"));
      }

      async function onGoogleCredential(response) {
        const credential = String(response && response.credential || "").trim();
        if (!credential) {
          msg.textContent = "Nao foi possivel receber a credencial do Google.";
          msg.style.color = "#b4233d";
          return;
        }

        msg.textContent = "Validando conta Google...";
        msg.style.color = "";

        try {
          const data = await apiRequest("/auth/google", { credential: credential });
          if (data && data.pending_approval) {
            msg.textContent = "Perfil criado com Google e enviado para aprovacao.";
            msg.style.color = "#e8f7ef";
            return;
          }

          persistSession(data, (data && data.usuario && data.usuario.nome) || "Google", (data && data.usuario && data.usuario.perfil) || "CONTABIL");
          window.location.href = next;
        } catch (err) {
          msg.textContent = err && err.message ? err.message : "Falha no login com Google.";
          msg.style.color = "#b4233d";
        }
      }

      async function initializeGoogleAuth() {
        const clientId = String(GOOGLE_CLIENT_ID || "").trim();
        if (!clientId || !googleAuthBlock || !googleLoginButton) {
          return;
        }

        try {
          await loadExternalScript("https://accounts.google.com/gsi/client");
          if (!(window.google && window.google.accounts && window.google.accounts.id)) {
            throw new Error("google identity indisponivel");
          }

          googleAuthBlock.hidden = false;
          window.google.accounts.id.initialize({
            client_id: clientId,
            callback: onGoogleCredential,
            auto_select: false,
            cancel_on_tap_outside: true
          });
          googleLoginButton.innerHTML = "";
          window.google.accounts.id.renderButton(googleLoginButton, {
            type: "standard",
            theme: "outline",
            size: "large",
            text: "continue_with",
            shape: "pill",
            width: 320,
            logo_alignment: "left"
          });
        } catch (_err) {
          googleAuthBlock.hidden = true;
        }
      }

      initializeGoogleAuth();

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const n = String(nome.value || "").trim();
        const s = String(senha.value || "").trim();
        if (!n || !s) {
          msg.textContent = "Informe nome de usuario ou Gmail e senha.";
          msg.style.color = "#b4233d";
          return;
        }

        msg.textContent = "Autenticando...";
        msg.style.color = "";

        try {
          const data = await apiRequest("/auth/login", { nome: n, senha: s });
          persistSession(data, n, "CONTABIL");
          window.location.href = next;
        } catch (err) {
          msg.textContent = err && err.message ? err.message : "Falha no login.";
          msg.style.color = "#b4233d";
        }
      });

    })();
  </script>
</body>
</html>
