<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Criar Perfil - Prototipo SEC Emendas</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="style.css" />
  <style>
    .auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .auth-shell {
      width: min(500px, 96vw);
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(6, 18, 36, 0.2);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .auth-links { display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <main class="auth-page">
    <section class="auth-shell">
      <h1>Criar perfil</h1>
      <p class="muted small">Informe nome, perfil e senha.</p>

      <form id="cadastroForm" class="auth-form">
        <div class="field">
          <label for="nome">Nome</label>
          <input id="nome" autocomplete="username" required />
        </div>
        <div class="field">
          <label for="perfil">Perfil</label>
          <select id="perfil" required></select>
        </div>
        <div class="field">
          <label for="senha">Senha</label>
          <input id="senha" type="password" autocomplete="new-password" required />
        </div>
        <div class="field">
          <label for="senha2">Confirmar senha</label>
          <input id="senha2" type="password" autocomplete="new-password" required />
        </div>
        <button type="submit" class="btn primary">Criar perfil</button>
      </form>

      <div class="auth-links">
        <a class="btn" id="linkLogin" href="login.html">Ja tenho conta</a>
        <a class="btn" href="index.html">Voltar</a>
      </div>

      <p id="cadastroModeHint" class="muted small"></p>
      <p id="msg" class="muted small"></p>
    </section>
  </main>

  <script src="config.js"></script>
  <script src="config.production.js"></script>
  <script>
    (function () {
      const API_BASE_URL_KEY = "SEC_API_BASE_URL";
      const CFG = (window.SEC_APP_CONFIG && typeof window.SEC_APP_CONFIG === "object") ? window.SEC_APP_CONFIG : {};
      const CFG_HOST_MAP = (CFG.API_BASE_URL_BY_HOST && typeof CFG.API_BASE_URL_BY_HOST === "object") ? CFG.API_BASE_URL_BY_HOST : {};
      const CFG_HOST = (window.location && window.location.hostname) ? String(window.location.hostname) : "";
      const DEFAULT_API_BASE_URL = (CFG_HOST_MAP[CFG_HOST] ? String(CFG_HOST_MAP[CFG_HOST]) : "") || (CFG.API_BASE_URL ? String(CFG.API_BASE_URL) : "") || "http://localhost:8000";
      const SESSION_TOKEN_KEY = "SEC_SESSION_TOKEN";
      const USER_NAME_KEY = "SEC_USER_NAME";
      const USER_ROLE_KEY = "SEC_USER_ROLE";
      const ROLE_FALLBACK = ["APG", "SUPERVISAO", "CONTABIL", "POWERBI", "PROGRAMADOR"];
      const OWNER_ROLE = "PROGRAMADOR";
      const PUBLIC_ALLOWED = ["APG", "SUPERVISAO", "CONTABIL", "POWERBI"];
      const next = new URLSearchParams(window.location.search).get("next") || "index.html";

      const form = document.getElementById("cadastroForm");
      const nome = document.getElementById("nome");
      const perfil = document.getElementById("perfil");
      const senha = document.getElementById("senha");
      const senha2 = document.getElementById("senha2");
      const cadastroModeHint = document.getElementById("cadastroModeHint");
      const msg = document.getElementById("msg");
      let creatorMode = "public";
      let creatorName = "";
      let creatorRole = "";

      const linkLogin = document.getElementById("linkLogin");
      linkLogin.href = "login.html?next=" + encodeURIComponent(next);

      function getBaseUrl() {
        const raw = String(localStorage.getItem(API_BASE_URL_KEY) || "").trim();
        const base = raw || DEFAULT_API_BASE_URL;
        return base.replace(/\/+$/, "");
      }

      async function request(path, method, body, withAuth) {
        const opts = { method: method || "GET", headers: {} };
        if (withAuth) {
          const token = String(sessionStorage.getItem(SESSION_TOKEN_KEY) || "").trim();
          if (token) opts.headers["Authorization"] = "Bearer " + token;
        }
        if (body !== undefined) {
          opts.headers["Content-Type"] = "application/json";
          opts.body = JSON.stringify(body);
        }

        const resp = await fetch(getBaseUrl() + path, opts);
        const text = await resp.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch (_) {}

        if (!resp.ok) {
          const detail = json && json.detail ? json.detail : (text || ("HTTP " + resp.status));
          throw new Error(String(detail));
        }
        return json;
      }

      function getAllowedRoles() {
        if (creatorMode === "owner") return ROLE_FALLBACK.slice();
        return PUBLIC_ALLOWED.slice();
      }

      function updateModeHint() {
        if (!cadastroModeHint) return;
        if (creatorMode === "owner") {
          cadastroModeHint.textContent = "Modo gestor: " + creatorName + " (" + creatorRole + ") pode criar qualquer perfil.";
          return;
        }
        cadastroModeHint.textContent = "Cadastro publico: perfil fica em analise e o PROGRAMADOR aprova.";
      }

      async function detectCreatorMode() {
        const token = String(sessionStorage.getItem(SESSION_TOKEN_KEY) || "").trim();
        if (!token) {
          creatorMode = "public";
          creatorName = "";
          creatorRole = "";
          return;
        }

        try {
          const me = await request("/auth/me", "GET", undefined, true);
          creatorName = String(me && me.nome || "");
          creatorRole = String(me && me.perfil || "").toUpperCase();
          if (creatorRole === OWNER_ROLE) {
            creatorMode = "owner";
          } else {
            creatorMode = "public";
          }
        } catch (_) {
          creatorMode = "public";
          creatorName = "";
          creatorRole = "";
        }
      }

      async function loadRoles() {
        let roles = ROLE_FALLBACK.slice();
        try {
          const data = await request("/roles", "GET");
          const got = Array.isArray(data && data.roles) ? data.roles : [];
          if (got.length) roles = got.map(function (r) { return String(r || "").toUpperCase(); });
        } catch (_) {}

        const allowed = getAllowedRoles();
        const filtered = roles.filter(function (r) { return allowed.indexOf(r) >= 0; });
        fillRoleSelect(filtered.length ? filtered : allowed);
        updateModeHint();
      }

      function fillRoleSelect(roles) {
        perfil.innerHTML = "";
        roles.forEach(function (r) {
          const opt = document.createElement("option");
          opt.value = String(r || "").toUpperCase();
          opt.textContent = String(r || "").toUpperCase();
          perfil.appendChild(opt);
        });
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const n = String(nome.value || "").trim();
        const p = String(perfil.value || "").trim().toUpperCase();
        const s1 = String(senha.value || "").trim();
        const s2 = String(senha2.value || "").trim();
        const allowed = getAllowedRoles();

        if (!n || !p || !s1 || !s2) {
          msg.textContent = "Preencha todos os campos.";
          msg.style.color = "#b4233d";
          return;
        }
        if (s1 !== s2) {
          msg.textContent = "As senhas nao conferem.";
          msg.style.color = "#b4233d";
          return;
        }
        if (allowed.indexOf(p) < 0) {
          msg.textContent = "Perfil nao permitido para este tipo de cadastro.";
          msg.style.color = "#b4233d";
          return;
        }

        msg.textContent = "Cadastrando...";
        msg.style.color = "";

        try {
          const data = await request("/auth/register", "POST", { nome: n, perfil: p, senha: s1 }, creatorMode !== "public");

          if (creatorMode === "public") {
            if (data && data.pending_approval) {
              msg.textContent = "Cadastro enviado. Aguarde aprovacao do PROGRAMADOR.";
              msg.style.color = "#1f7a42";
              nome.value = "";
              senha.value = "";
              senha2.value = "";
              return;
            }

            if (data && data.token && data.usuario) {
              sessionStorage.setItem(SESSION_TOKEN_KEY, String(data.token || ""));
              localStorage.setItem(USER_NAME_KEY, String(data.usuario && data.usuario.nome || n));
              localStorage.setItem(USER_ROLE_KEY, String(data.usuario && data.usuario.perfil || p));
              window.location.href = next;
              return;
            }

            msg.textContent = "Cadastro realizado, mas sem sessao ativa.";
            msg.style.color = "#1f7a42";
            return;
          }

          msg.textContent = "Perfil criado com sucesso: " + n + " (" + p + ").";
          msg.style.color = "#1f7a42";
          nome.value = "";
          senha.value = "";
          senha2.value = "";
        } catch (err) {
          msg.textContent = err && err.message ? err.message : "Falha no cadastro.";
          msg.style.color = "#b4233d";
        }
      });

      (async function init() {
        await detectCreatorMode();
        await loadRoles();
      })();
    })();
  </script>
</body>
</html>


